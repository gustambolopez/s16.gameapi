import express from"express";import fetch from"node-fetch";import{hostname}from"os";const app=express(),port=process.env.PORT||8080,cachesearch=new Map,cacheduration=36e4;app.use(express.json());import{api_graphql,link_base,linksuffix,Image}from"./value.js";const image_suffix="-512x512",image_suffixtwo="-512x384";async function checkstatus(e){try{return(await fetch(e,{method:"HEAD",timeout:5e3})).ok?e:null}catch(r){return console.error(`Error in the image ${e}:`,r.message),null}}async function theresultlmao(e){const r=e.id,s=`${link_base}${r}${linksuffix}`,t="-512x512",o="-512x384",a=[`${Image}${r}${t}.jpg`,`${Image}${r}${t}.jpeg`,`${Image}${r}${t}.png`,`${Image}${r}${t}.webp`,`${Image}${r}${o}.jpg`,`${Image}${r}${o}.jpeg`,`${Image}${r}${o}.png`,`${Image}${r}${o}.webp`];let n=null;for(const e of a){const r=await checkstatus(e);if(r){n=r;break}}const{id:c,...i}=e,l={...i,link:s};return n&&(l.img=n),l}app.get("/v0/api/games/q=:searchTerm",(async(e,r)=>{const s=e.params.searchTerm,t=parseInt(e.query.quantity)||21e3,o=void 0!==e.query.sortBytitle,a=`${s}-${t}-${o}`;if(cachesearch.has(a)){const e=cachesearch.get(a);if(Date.now()-e.timestamp<36e4)return console.log("loading from cache:",a),r.json(e.results);cachesearch.delete(a)}const n=`\n        query GetSearchResults {\n            results(search: "${s}", limit: ${t}, offset: 0) {\n                title\n                id\n                description\n            }\n        }\n    `;try{const e=await fetch(api_graphql,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify({query:n})});if(!e.ok){const s=await e.text();return console.error(`GraphQL error ${e.status}: ${s}`),r.status(e.status).json({error:`Fetch failed: ${s}`})}const s=await e.json();if(s.errors)return console.error("GraphQL returned errors:",s.errors),r.status(500).json({error:"GraphQL errors",details:s.errors});const t=Array.isArray(s?.data?.results)?await Promise.all(s.data.results.map((e=>theresultlmao(e)))):[];if(0===t.length)return r.status(404).json({error:"No games found for that search term try searching another one maybe"});o&&t.sort(((e,r)=>e.title.localeCompare(r.title))),cachesearch.set(a,{results:t,timestamp:Date.now()}),console.log("Stored cache:",a),r.json(t)}catch(e){console.error("Fetch error:",e),r.status(500).json({error:"Server error",details:e.message})}})),app.get("/v0/api/games/:id",(async(e,r)=>{const s=e.params.id,t=`\n        query {\n            results(search: "${s}", limit: 1, offset: 0) {\n                title\n                id\n                description\n            }\n        }\n    `;try{const e=await fetch(api_graphql,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify({query:t})});if(!e.ok){const s=await e.text();return console.error(`GraphQL error ${e.status}: ${s}`),r.status(e.status).json({error:`Fetch failed: ${s}`})}const o=await e.json();if(o.errors)return console.error("GraphQL returned errors:",o.errors),r.status(500).json({error:"GraphQL errors",details:o.errors});const a=o?.data?.results?.find((e=>e.id===s)),n=a?await theresultlmao(a):null;n?r.json([n]):r.status(404).json({error:"Game not found, is the ID correct or does it exist?"})}catch(e){console.error("Fetch error:",e),r.status(500).json({error:"Server error",details:e.message})}}));const DEV_MESSAGE=process.env.DEV_MESSAGE||'(Hosted on heaven previously altera, go check it here "https://discord.gg/qk4HmXf8tz"). to search something try /v0/api/games/q=(yoursearch)';let server;function shutdown(){console.log("SIGTERM signal received: closing HTTP server"),server.close((()=>{console.log("https server closed."),process.exit(0)}))}app.get("/",((e,r)=>{r.send(DEV_MESSAGE)})),process.on("SIGINT",shutdown),process.on("SIGTERM",shutdown),server=app.listen(port,(()=>{const e=server.address();console.log("Listening on:"),console.log(`\thttp://localhost:${e.port}`),console.log(`\thttp://${hostname()}:${e.port}`),console.log(`\thttp://${"IPv6"===e.family?`[${e.address}]`:e.address}:${e.port}`)}));
